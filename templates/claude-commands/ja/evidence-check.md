# エビデンスチェック

レポートや論文の参考文献・引用の妥当性を検証し、問題を修正します。

## 実行内容

1. **参考文献の存在確認**
   - リンク先のコンテンツが存在するか
   - 複数の方法でアクセスを試行（WebFetch、代替手段）
   - アクセス不可の場合、人間の支援を要請

2. **引用内容の整合性確認**
   - コンテンツが引用内容と合致するか
   - 数値や客観情報が正確か
   - 不一致がある場合、正しい情報を提示

3. **文脈の適切性確認**
   - 引用が文脈に適しているか
   - 引用元の意図と合致しているか

4. **自動修正と人間支援**
   - 修正可能な問題は自動的に修正案を提示
   - AIでアクセス不可の場合、ユーザーに確認を依頼
   - 修正後、再チェックを実施

## 使用方法

```
/evidence-check [ファイルパスまたはテキスト]
```

### 引数なし（全体チェック）

```
/evidence-check
```

カレントディレクトリ配下の文書ファイル（.md, .txt, .tex等）を検索し、
すべての参考文献・引用をチェックします。

### 引数あり（特定箇所チェック）

```
/evidence-check docs/report.md
/evidence-check "第3章の統計データ"
```

指定されたファイルまたは該当箇所のみをチェックします。

## 実行手順

### 1. 対象ファイルの特定

引数が指定されている場合：
- ファイルパスの場合：そのファイルを対象
- テキストの場合：該当する箇所を検索

引数なしの場合：
- カレントディレクトリ以下の文書ファイルを検索
- .md, .txt, .tex, .docx等を対象

### 2. 参考文献の抽出

以下のパターンを検出：
- URLリンク: `http://...`, `https://...`
- 文献引用: `[1]`, `(Smith, 2020)`, `※参考: ...`
- 脚注参照: `^[...]`, footnote形式
- 画像・図表の出典: `出典: ...`, `Source: ...`

### 3. 並列チェック（複数参考文献がある場合）

**Taskツールを活用した並列処理：**

```
対象文献が2つ以上ある場合は、Taskツールで複数の調査エージェントを
並列起動し、効率的にチェックします。
```

各エージェントは以下を実行：
- WebFetchツールでリンク先を取得
- 引用内容との整合性を確認
- 結果をレポート

### 4. 整合性の検証（多段階アプローチ）

各参考文献について以下を実施：

**ステップ1: アクセス試行**
1. WebFetchツールでコンテンツ取得を試行
2. 失敗した場合、代替アプローチを試行：
   - URLのバリエーション（http/https、www有無）
   - Archive.orgのスナップショット確認
   - DOIからのリダイレクト確認
3. 全て失敗した場合：
   - ユーザーに手動確認を依頼
   - AskUserQuestionツールで「このURLにアクセスできますか？」と質問
   - アクセス可能な場合、ユーザーに内容の要約を依頼

**ステップ2: 内容確認**
1. 引用された数値・情報が原文に存在するか確認
2. 不一致がある場合：
   - 正しい情報を特定
   - 修正案を提示
   - ユーザーに確認を求める

**ステップ3: 文脈確認**
1. 引用の使い方が適切か評価
2. ミスリーディングな引用でないか確認
3. 問題がある場合、改善案を提示

### 5. レポート生成と修正案の提示

チェック結果を以下の形式で出力：

```markdown
## エビデンスチェック結果

### ✅ 問題なし（X件）

| 箇所 | 参考文献 | 確認内容 |
|------|----------|----------|
| p.5 | https://example.com/data | 統計データ一致 |

### 🔧 自動修正可能（Y件）

| 箇所 | 参考文献 | 問題点 | 修正案 |
|------|----------|--------|--------|
| p.20 | (Smith, 2020) | 数値が3.5%と記載、原文は3.6% | 「3.6%」に修正 |
| p.30 | https://old-site.com | リンク切れ（新URL発見） | `https://new-site.com` に更新 |

**修正を適用しますか？ [Y/n]**

### ⚠️ 人間の確認が必要（Z件）

| 箇所 | 参考文献 | 問題点 | 対応依頼 |
|------|----------|--------|----------|
| p.12 | https://paywalled.com | AIからアクセス不可 | ユーザー確認待ち |
| p.25 | (Jones, 2019) | 文脈の適切性に疑問 | 専門家レビュー推奨 |

**確認が必要な項目：**

#### 📋 項目1: p.12のpaywalledコンテンツ
- **URL**: https://paywalled.com/article
- **引用内容**: 「市場シェアは45%」
- **状況**: 認証が必要でAIからアクセス不可
- **依頼**: このURLにアクセスできますか？もしアクセス可能なら、
  「市場シェア」に関する記述を教えてください。

#### 📋 項目2: p.25の文脈確認
- **引用**: 「Jones (2019)によると、この手法は効果的である」
- **原文**: 「この手法は特定の条件下でのみ効果的」
- **問題**: 条件を省略した引用でミスリーディングの可能性
- **提案**: 「Jones (2019)によると、特定の条件下でこの手法は効果的である」

### ❌ 重大な問題（W件）

| 箇所 | 参考文献 | 問題点 | 推奨対応 |
|------|----------|--------|----------|
| p.15 | https://404.com | ページが存在しない（Archive.orgにも無し） | 引用削除または代替文献 |
| p.40 | (Black, 2018) | 原文に該当する記述なし | 引用削除 |

## 次のステップ

1. **自動修正の適用** (Y/n で選択)
2. **人間確認項目への対応** (上記の依頼に回答)
3. **重大な問題の修正** (文書の編集が必要)
4. **再チェックの実行** (修正後、再度エビデンスチェック)
```

### 6. 対話的な修正プロセス

修正が必要な場合：

1. **自動修正可能な項目**
   - ユーザーに確認を求める（AskUserQuestionツール）
   - 承認されたら、Editツールで自動修正
   - 修正内容をログに記録

2. **人間確認が必要な項目**
   - AskUserQuestionツールで具体的な質問
   - ユーザーの回答を受け取る
   - 回答に基づいて適切な対応を提案

3. **重大な問題**
   - 修正方針をユーザーと協議
   - 代替案を提示
   - 合意した方針で修正

4. **再チェック**
   - 修正完了後、自動的に再チェックを実行
   - 全ての問題が解決されるまで繰り返す

## 使用例

### 例1: 特定ファイルのチェック

```
/evidence-check docs/research-paper.md
```

→ research-paper.md内のすべての参考文献をチェック

### 例2: 特定章のチェック

```
/evidence-check "第3章 実験結果"
```

→ 第3章に関連する参考文献のみをチェック

### 例3: プロジェクト全体のチェック

```
/evidence-check
```

→ すべての文書ファイルの参考文献をチェック

## 実装の詳細

### 並列処理の判断基準

```
参考文献数が2件以上の場合：
  → Taskツールで並列チェック（最大5エージェント同時実行）

参考文献数が1件のみの場合：
  → 単独チェック
```

### チェック項目の優先度

**高優先度（必須）：**
- リンク先の存在確認
- 数値データの一致確認

**中優先度（推奨）：**
- 文脈の適切性
- 引用元の意図との整合性

**低優先度（任意）：**
- 引用形式の統一性
- 参考文献リストの完全性

## 注意事項とベストプラクティス

### AIの制限と対処法

**アクセス制限：**
- WebFetchで直接アクセスできないサイトがある
- 対処：複数の方法を試行し、失敗時は人間に支援を要請

**動的コンテンツ：**
- JavaScript必須のページは正しく取得できない可能性
- 対処：Archive.orgやキャッシュサイトを試行

**認証が必要なコンテンツ：**
- 有料コンテンツや会員限定ページはAIからアクセス不可
- 対処：ユーザーに手動確認を依頼し、内容の要約を取得

### 効率的な使用方法

1. **段階的チェック**：
   - まず全体をチェックしてエラーを特定
   - 問題箇所を修正
   - 再チェックで検証

2. **人間との協働**：
   - AIがアクセスできない箇所は遠慮なく依頼
   - ユーザーの専門知識を活用（文脈の適切性判断）

3. **定期的な実行**：
   - 文書の大幅な更新後
   - 最終提出前の品質確認
   - 参考文献追加時

## エラーハンドリング

- **ネットワークエラー**: 一時的な問題の可能性を示唆
- **404エラー**: リンク切れとして報告
- **アクセス拒否**: 認証が必要な可能性を示唆
- **タイムアウト**: サイトの応答が遅い可能性を示唆

---

**重要**: このコマンドは参考文献の技術的な妥当性をチェックしますが、
学術的・専門的な内容の正確性については、専門家によるレビューが必要です。
