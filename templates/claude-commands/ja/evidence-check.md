# エビデンスチェック

レポートや論文の参考文献・引用の妥当性を検証し、問題を修正します。

## 実行内容

1. **参考文献の存在確認**
   - リンク先のコンテンツが存在するか
   - 複数の方法でアクセスを試行（WebFetch、代替手段）
   - アクセス不可の場合、人間の支援を要請

2. **引用内容の整合性確認**
   - コンテンツが引用内容と合致するか
   - 数値や客観情報が正確か
   - 不一致がある場合、正しい情報を提示

3. **文脈の適切性確認**
   - 引用が文脈に適しているか
   - 引用元の意図と合致しているか

4. **自動修正と人間支援**
   - 修正可能な問題は自動的に修正案を提示
   - AIでアクセス不可の場合、ユーザーに確認を依頼
   - 修正後、再チェックを実施

## 使用方法

```
/evidence-check [ファイルパスまたはテキスト]
```

### 引数なし（全体チェック）

```
/evidence-check
```

カレントディレクトリ配下の文書ファイル（.md, .txt, .tex等）を検索し、
すべての参考文献・引用をチェックします。

### 引数あり（特定箇所チェック）

```
/evidence-check docs/report.md
/evidence-check "第3章の統計データ"
```

指定されたファイルまたは該当箇所のみをチェックします。

## 実行手順

### 1. 対象ファイルの特定

引数が指定されている場合：
- ファイルパスの場合：そのファイルを対象
- テキストの場合：該当する箇所を検索

引数なしの場合：
- カレントディレクトリ以下の文書ファイルを検索
- .md, .txt, .tex, .docx等を対象

### 2. 参考文献の抽出

以下のパターンを検出：
- URLリンク: `http://...`, `https://...`
- 文献引用: `[1]`, `(Smith, 2020)`, `※参考: ...`
- 脚注参照: `^[...]`, footnote形式
- 画像・図表の出典: `出典: ...`, `Source: ...`

### 3. 並列チェック（複数参考文献がある場合）

**Taskツールを活用した並列処理：**

```
対象文献が2つ以上ある場合は、Taskツールで複数の調査エージェントを
並列起動し、効率的にチェックします。
```

各エージェントは以下を実行：
- WebFetchツールでリンク先を取得
- 引用内容との整合性を確認
- 結果をレポート

### 4. 整合性の検証（多段階アプローチ）

各参考文献について以下を実施：

**ステップ1: アクセス試行**
1. WebFetchツールでコンテンツ取得を試行
2. 失敗した場合、代替アプローチを試行：
   - URLのバリエーション（http/https、www有無）
   - Archive.orgのスナップショット確認
   - DOIからのリダイレクト確認
3. 全て失敗した場合：
   - ユーザーに手動確認を依頼
   - AskUserQuestionツールで「このURLにアクセスできますか？」と質問
   - アクセス可能な場合、ユーザーに内容の要約を依頼

**ステップ2: 内容確認**
1. 引用された数値・情報が原文に存在するか確認
2. 不一致がある場合：
   - 正しい情報を特定
   - 修正案を提示
   - ユーザーに確認を求める

**ステップ3: 文脈確認**
1. 引用の使い方が適切か評価
2. ミスリーディングな引用でないか確認
3. 問題がある場合、改善案を提示

### 5. レポート生成と修正案の提示

チェック結果を以下の形式で出力：

```markdown
# エビデンスチェックレポート

**チェック日時**: 2025-01-22 14:30:00
**対象ファイル**: docs/research-paper.md
**総参考文献数**: 25件

---

## 📊 サマリー

| ステータス | 件数 | 割合 |
|-----------|------|------|
| ✅ 問題なし | 18 | 72% |
| 🔧 自動修正可能 | 3 | 12% |
| ⚠️ 人間確認必要 | 2 | 8% |
| ❌ 重大な問題 | 2 | 8% |

---

## ✅ 問題なし（18件）

<details>
<summary>詳細を表示</summary>

### 1. 統計データの引用
- **ファイル**: docs/research-paper.md:45
- **引用箇所**:
  ```
  市場規模は2023年時点で約1.2兆円である[1]。
  ```
- **参考文献**: [1] https://example.com/market-report-2023
- **確認内容**:
  - ✓ リンク先アクセス可能
  - ✓ 数値「1.2兆円」が原文と一致
  - ✓ 「2023年時点」の記述も一致
- **検証方法**: WebFetch → 原文比較
- **確認日時**: 2025-01-22 14:31:15

### 2. 先行研究の引用
- **ファイル**: docs/research-paper.md:78
- **引用箇所**:
  ```
  Smith et al. (2020)は、この手法の有効性を実証している。
  ```
- **参考文献**: Smith, J., Brown, A. (2020). "Effective Methods in AI"
- **確認内容**:
  - ✓ 文献データベースで存在確認
  - ✓ 著者名・年度が正確
  - ✓ 引用文脈が適切
- **検証方法**: DOI検索 → 内容確認
- **確認日時**: 2025-01-22 14:32:03

[... 残り16件の詳細 ...]

</details>

---

## 🔧 自動修正可能（3件）

### 1. 数値の軽微な不一致
- **ファイル**: docs/research-paper.md:120
- **引用箇所**:
  ```markdown
  120: 成長率は年平均3.5%と報告されている(Smith, 2020)。
  ```
- **参考文献**: (Smith, 2020) https://example.com/growth-analysis
- **問題点**:
  - 文書記載: 「3.5%」
  - 原文記載: 「3.6%」
  - 差異: 0.1ポイント
- **原文の該当箇所**:
  ```
  The annual average growth rate was measured at 3.6% over the period.
  ```
- **修正案**:
  ```diff
  - 成長率は年平均3.5%と報告されている(Smith, 2020)。
  + 成長率は年平均3.6%と報告されている(Smith, 2020)。
  ```
- **修正対象**: docs/research-paper.md:120
- **自動修正コマンド**: Edit tool (old_string → new_string)
- **検証方法**: WebFetch → 数値抽出・比較
- **発見日時**: 2025-01-22 14:33:21

### 2. リンク切れ（新URLが判明）
- **ファイル**: docs/research-paper.md:145
- **引用箇所**:
  ```markdown
  145: 詳細なデータは公式サイト[2]を参照。
  145: [2]: https://old-site.com/data/report2023.pdf
  ```
- **参考文献**: https://old-site.com/data/report2023.pdf
- **問題点**:
  - HTTPステータス: 404 Not Found
  - Archive.org: 移転情報あり
  - 新URL: https://new-site.com/resources/report2023.pdf
- **確認プロセス**:
  1. WebFetch → 404エラー
  2. Archive.org検索 → リダイレクト情報発見
  3. 新URL検証 → アクセス成功、内容一致確認
- **修正案**:
  ```diff
  - [2]: https://old-site.com/data/report2023.pdf
  + [2]: https://new-site.com/resources/report2023.pdf
  ```
- **修正対象**: docs/research-paper.md:145
- **自動修正コマンド**: Edit tool
- **検証方法**: Archive.org → 新URL検証
- **発見日時**: 2025-01-22 14:34:45

### 3. プロトコルの修正（HTTP→HTTPS）
- **ファイル**: docs/research-paper.md:203
- **引用箇所**:
  ```markdown
  203: [5]: http://example.org/paper.pdf
  ```
- **参考文献**: http://example.org/paper.pdf
- **問題点**:
  - HTTPでアクセス → HTTPS自動リダイレクト
  - セキュリティ推奨: HTTPS使用
- **修正案**:
  ```diff
  - [5]: http://example.org/paper.pdf
  + [5]: https://example.org/paper.pdf
  ```
- **修正対象**: docs/research-paper.md:203
- **自動修正コマンド**: Edit tool
- **検証方法**: HTTPS接続確認
- **発見日時**: 2025-01-22 14:35:12

**自動修正を適用しますか？ [Y/n]**
→ Yを選択すると、上記3件をEditツールで一括修正します。

---

## ⚠️ 人間の確認が必要（2件）

### 1. 有料コンテンツへのアクセス制限
- **ファイル**: docs/research-paper.md:167
- **引用箇所**:
  ```markdown
  167: 業界シェアは45%に達している(Johnson, 2023)。
  ```
- **参考文献**: Johnson, M. (2023). https://journal.example.com/article/12345
- **問題点**:
  - AIからのアクセス: 不可（認証が必要）
  - HTTPステータス: 403 Forbidden (Paywall)
  - 試行した方法:
    1. WebFetch → 認証エラー
    2. DOI検索 → 有料ジャーナル確認
    3. Archive.org → スナップショットなし
- **引用内容**: 「業界シェアは45%」
- **確認依頼**:
  ```
  このURLにアクセスできますか？
  https://journal.example.com/article/12345

  アクセス可能な場合、以下の情報を教えてください：
  1. 「業界シェア」または「market share」に関する記述
  2. 「45%」という数値の有無と文脈
  3. 該当する段落または節の要約
  ```
- **対応方法**: AskUserQuestionツールで確認
- **発見日時**: 2025-01-22 14:36:30

### 2. 文脈の適切性に疑問
- **ファイル**: docs/research-paper.md:189
- **引用箇所**:
  ```markdown
  189: Jones (2019)によると、この手法は効果的である。
  ```
- **参考文献**: Jones, K. (2019). https://example.com/methods-study
- **問題点**:
  - 原文の記述:
    ```
    This method is effective only under specific conditions,
    particularly when the sample size exceeds 1000 participants
    and the control group is properly isolated.
    ```
  - 引用の問題: 条件（サンプルサイズ>1000、適切な対照群）を省略
  - ミスリーディングの可能性: あり
- **文脈比較**:
  - 文書の主張: 「この手法は（一般的に）効果的」
  - 原文の主張: 「特定条件下でのみ効果的」
  - ギャップ: 適用範囲の過度な一般化
- **修正提案**:
  ```diff
  - Jones (2019)によると、この手法は効果的である。
  + Jones (2019)によると、サンプルサイズが1000以上の場合に
  + この手法は効果的である。
  ```
  または
  ```diff
  - Jones (2019)によると、この手法は効果的である。
  + Jones (2019)によると、特定の条件下でこの手法は効果的である。
  ```
- **確認依頼**:
  ```
  どちらの修正案を採用しますか？
  A) 具体的な条件（サンプルサイズ1000以上）を明記
  B) 「特定の条件下」と簡潔に記載
  C) その他（自由記述）
  ```
- **対応方法**: AskUserQuestionツールで選択
- **発見日時**: 2025-01-22 14:37:50

---

## ❌ 重大な問題（2件）

### 1. ページが存在しない
- **ファイル**: docs/research-paper.md:98
- **引用箇所**:
  ```markdown
  98: 詳細は参考資料[3]を参照のこと。
  98: [3]: https://oldsite.example.com/report2022.html
  ```
- **参考文献**: https://oldsite.example.com/report2022.html
- **問題点**:
  - HTTPステータス: 404 Not Found
  - 試行した復旧方法:
    1. WebFetch → 404エラー
    2. URLバリエーション試行 → 全て失敗
    3. Archive.org検索 → スナップショット0件
    4. ドメイン確認 → サイト自体が閉鎖
- **影響度**: 高（引用元が完全に消失）
- **推奨対応**:
  ```
  選択肢:
  1. この引用を削除し、該当箇所を書き直す
  2. 同等の代替文献を探して差し替える
  3. 「参照不可」の注釈を付けて残す（非推奨）
  ```
- **修正対象**: docs/research-paper.md:98
- **必要な作業**: 文書の編集または代替文献の調査
- **発見日時**: 2025-01-22 14:38:45

### 2. 引用内容が原文と不一致
- **ファイル**: docs/research-paper.md:234
- **引用箇所**:
  ```markdown
  234: Black (2018)は、初期段階での介入が成功率を80%向上させると報告している。
  ```
- **参考文献**: Black, R. (2018). https://example.com/intervention-study
- **問題点**:
  - 文書の記述: 「成功率を80%向上」
  - 原文の実際の内容:
    ```
    Early intervention showed a 15% improvement in success rates
    compared to the control group (p < 0.05).
    ```
  - 不一致: 数値が大幅に異なる（15% vs 80%）
  - 「80%」の記述: 原文中に存在しない
- **原文全体の検索結果**:
  - "80%" → 0件
  - "eighty percent" → 0件
  - "improve.*success" → 「15% improvement」のみ
- **考えられる原因**:
  1. 異なる論文との混同
  2. 記憶違い
  3. 誤った計算・解釈
- **影響度**: 極めて高（事実と異なる主張）
- **推奨対応**:
  ```
  必須対応:
  1. 正しい数値（15%）に修正
  2. または、この引用を削除
  3. 「80%」の出典を再調査（別の論文の可能性）
  ```
- **修正案**:
  ```diff
  - Black (2018)は、初期段階での介入が成功率を80%向上させると報告している。
  + Black (2018)は、初期段階での介入が成功率を15%向上させると報告している。
  ```
- **修正対象**: docs/research-paper.md:234
- **必要な作業**: ユーザーによる確認と修正方針の決定
- **発見日時**: 2025-01-22 14:40:12

---

## 📝 修正履歴（自動修正適用後に記録）

### 修正セッション #1
**実行日時**: 2025-01-22 14:45:00
**実行者**: AI (ユーザー承認済み)

| 項目 | ファイル:行 | 修正内容 | ステータス |
|------|------------|---------|-----------|
| 1 | docs/research-paper.md:120 | 3.5% → 3.6% | ✅ 完了 |
| 2 | docs/research-paper.md:145 | URL更新 | ✅ 完了 |
| 3 | docs/research-paper.md:203 | HTTP→HTTPS | ✅ 完了 |

**修正詳細**:

#### 修正 #1
```diff
File: docs/research-paper.md
Line: 120

- 成長率は年平均3.5%と報告されている(Smith, 2020)。
+ 成長率は年平均3.6%と報告されている(Smith, 2020)。

Editツール実行: 成功
検証: 再チェック実施 → 問題解消確認
```

#### 修正 #2
```diff
File: docs/research-paper.md
Line: 145

- [2]: https://old-site.com/data/report2023.pdf
+ [2]: https://new-site.com/resources/report2023.pdf

Editツール実行: 成功
検証: 新URL接続確認 → アクセス成功
```

#### 修正 #3
```diff
File: docs/research-paper.md
Line: 203

- [5]: http://example.org/paper.pdf
+ [5]: https://example.org/paper.pdf

Editツール実行: 成功
検証: HTTPS接続確認 → アクセス成功
```

**修正後の再チェック結果**: 3件の問題が解消されました。

---

## 次のステップ

### 即座に対応可能
- [x] 🔧 自動修正可能な3件 → 修正完了

### ユーザーの対応が必要
- [ ] ⚠️ 人間確認必要な2件
  - [ ] 項目1: 有料コンテンツの手動確認
  - [ ] 項目2: 文脈修正案の選択
- [ ] ❌ 重大な問題2件
  - [ ] 項目1: 404エラーの引用削除または代替文献
  - [ ] 項目2: 不一致データの修正

### 推奨される作業フロー
1. ⚠️項目に回答（AskUserQuestionで対話）
2. ❌項目を修正（手動またはAI支援）
3. 全修正完了後、`/evidence-check`を再実行
4. 問題0件になるまで繰り返し

---

## 📋 添付情報

### チェックに使用したツール
- WebFetch: 23回実行（成功: 20, 失敗: 3）
- Archive.org: 2回検索
- DOI検索: 3回実行
- Grep: 参考文献パターン検索

### 処理時間
- 総実行時間: 2分15秒
- 並列処理: 5エージェント使用（最大同時実行）

### ログファイル
- 詳細ログ: `.evidence-check/log-2025-01-22-143000.json`
- エラーログ: `.evidence-check/errors-2025-01-22-143000.log`
```

### 6. 対話的な修正プロセス

修正が必要な場合：

1. **自動修正可能な項目**
   - ユーザーに確認を求める（AskUserQuestionツール）
   - 承認されたら、Editツールで自動修正
   - 修正内容をログに記録

2. **人間確認が必要な項目**
   - AskUserQuestionツールで具体的な質問
   - ユーザーの回答を受け取る
   - 回答に基づいて適切な対応を提案

3. **重大な問題**
   - 修正方針をユーザーと協議
   - 代替案を提示
   - 合意した方針で修正

4. **再チェック**
   - 修正完了後、自動的に再チェックを実行
   - 全ての問題が解決されるまで繰り返す

## 使用例

### 例1: 特定ファイルのチェック

```
/evidence-check docs/research-paper.md
```

→ research-paper.md内のすべての参考文献をチェック

### 例2: 特定章のチェック

```
/evidence-check "第3章 実験結果"
```

→ 第3章に関連する参考文献のみをチェック

### 例3: プロジェクト全体のチェック

```
/evidence-check
```

→ すべての文書ファイルの参考文献をチェック

## 実装の詳細

### 並列処理の判断基準

```
参考文献数が2件以上の場合：
  → Taskツールで並列チェック（最大5エージェント同時実行）

参考文献数が1件のみの場合：
  → 単独チェック
```

### チェック項目の優先度

**高優先度（必須）：**
- リンク先の存在確認
- 数値データの一致確認

**中優先度（推奨）：**
- 文脈の適切性
- 引用元の意図との整合性

**低優先度（任意）：**
- 引用形式の統一性
- 参考文献リストの完全性

## 注意事項とベストプラクティス

### AIの制限と対処法

**アクセス制限：**
- WebFetchで直接アクセスできないサイトがある
- 対処：複数の方法を試行し、失敗時は人間に支援を要請

**動的コンテンツ：**
- JavaScript必須のページは正しく取得できない可能性
- 対処：Archive.orgやキャッシュサイトを試行

**認証が必要なコンテンツ：**
- 有料コンテンツや会員限定ページはAIからアクセス不可
- 対処：ユーザーに手動確認を依頼し、内容の要約を取得

### 効率的な使用方法

1. **段階的チェック**：
   - まず全体をチェックしてエラーを特定
   - 問題箇所を修正
   - 再チェックで検証

2. **人間との協働**：
   - AIがアクセスできない箇所は遠慮なく依頼
   - ユーザーの専門知識を活用（文脈の適切性判断）

3. **定期的な実行**：
   - 文書の大幅な更新後
   - 最終提出前の品質確認
   - 参考文献追加時

## エラーハンドリング

- **ネットワークエラー**: 一時的な問題の可能性を示唆
- **404エラー**: リンク切れとして報告
- **アクセス拒否**: 認証が必要な可能性を示唆
- **タイムアウト**: サイトの応答が遅い可能性を示唆

---

**重要**: このコマンドは参考文献の技術的な妥当性をチェックしますが、
学術的・専門的な内容の正確性については、専門家によるレビューが必要です。
